<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile-Optimized Iframe</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #downloadLinkContainer {
            width: 100%;
            padding: 10px;
            background-color: #f0f0f0;
            text-align: center;
        }
        #downloadLink {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px;
        }
        iframe {
            flex-grow: 1;
            width: 100%;
            border: none;
            margin: 0;
        }
        
        body {
            -webkit-text-size-adjust: 100%;
        }
        
        iframe {
            will-change: scroll-position;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="downloadLinkContainer"></div>
        <iframe 
            id="myIframe" 
            src="https://script.google.com/macros/s/AKfycbyq9LhdYxlJPhZIhguvrfUFP9BM6N3DdSCcXxmhx4uJY_0hUunZp1E_JSKwP-pa8Brj/exec" 
            sandbox="allow-scripts allow-same-origin allow-forms"
            allowfullscreen 
            webkitallowfullscreen 
            mozallowfullscreen
        ></iframe>
    </div>

    <script>
        const iframe = document.getElementById('myIframe');
        const downloadContainer = document.getElementById('downloadLinkContainer');

        // Cross-window communication for scroll position
        function saveIframeScroll(scrollPosition) {
            try {
                localStorage.setItem('iframeScrollPosition', scrollPosition);
            } catch (error) {
                console.warn('Could not save scroll position:', error);
            }
        }

        function restoreIframeScroll() {
            try {
                const savedScroll = localStorage.getItem('iframeScrollPosition');
                if (savedScroll) {
                    // Send message to iframe to scroll
                    iframe.contentWindow.postMessage({
                        type: 'restoreScroll',
                        position: parseInt(savedScroll, 10)
                    }, '*');
                }
            } catch (error) {
                console.warn('Could not restore scroll position:', error);
            }
        }

        // Message listener for scroll and PDF link
        window.addEventListener('message', function(event) {
            // Handle scroll saving from iframe
            if (event.data && event.data.type === 'saveScroll') {
                saveIframeScroll(event.data.position);
            }
            
            // Handle PDF link download
            if (event.data && event.data.pdfLink) {
                console.log('Received PDF Link:', event.data.pdfLink);
                
                // Clear previous links
                downloadContainer.innerHTML = '';
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.href = event.data.pdfLink;
                downloadLink.id = 'downloadLink';
                downloadLink.download = 'Receipt.pdf';
                downloadLink.textContent = 'Download Receipt';
                downloadLink.target = '_blank';
                
                // Append link to container
                downloadContainer.appendChild(downloadLink);
                
                // Enhanced download handling
                function triggerDownload() {
                    try {
                        const clickEvent = new MouseEvent('click', { 
                            bubbles: true, 
                            cancelable: true, 
                            view: window 
                        });
                        downloadLink.dispatchEvent(clickEvent);
                    } catch (error) {
                        console.warn('Download trigger failed:', error);
                    }
                }
                
                // Delayed download trigger for WebView compatibility
                setTimeout(triggerDownload, 500);
            }
        }, false);

        // Restore scroll on load
        window.addEventListener('load', restoreIframeScroll);

        // Prevent overscroll and improve mobile experience
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
